<!--
	SLAPS (SLAPS Like A Punk Song) Web Audio Sequencer
	Copyright (C) 2023, Lance Giles & Dogman Devices

	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.

	You should have received a copy of the GNU General Public License
	along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->


<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="author" content="Lance Giles">
    <meta name="description" content="step sequencer and synthesizer">
    <title>Slaps - Step Sequencer</title>
    <meta name="description" content="A simple instrument for web browsers" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <style>
      :root {
        --text: black;
        --bg: #f0e4d1;
        --normal: #2d9f7b;
        --hover: #d5d2c8;
        --other: #8FBB99;
        --highlight: white;
      }

      * {
        box-sizing: border-box;
      }

      body {
      	background-color: var(--bg);
      	color: var(--text);
      }

      #controls {
      	display: grid;
      	justify-items: center;
        margin-top: 2rem;
        margin-bottom: 2rem;
      }

      #sliders {
        display: flex;
      }

      .container {
        display: flex;
        position: relative;
        padding-left: 35px;
        margin-bottom: 12px;
        cursor: pointer;
        font-size: 22px;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      .container input {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
      }

      .checkmark {
        position: absolute;
        top: 0;
        left: 0;
        height: 25px;
        width: 25px;
        background-color: var(--bg);
        border: solid var(--normal) 2px;
        border-radius: 50%;
      }

      .container:hover input ~ .checkmark {
        background-color: var(--hover);
      }

      .container input:checked ~ .checkmark {
        background-color: var(--normal);
      }

      .pads {
        display: flex;
        justify-content: space-between;
        padding: 2rem;
      }

      .pads p {
        display: none;
      }
</style>
  </head>

  <body>
    <section id="controls">
      <div id="sliders">
        <div id="volume-control">
          <label for="volume">volume</label>
          <input type="range" min="0" max="2" value="1" step="0.01" data-action="volume">
          <datalist id="gain-vals">
            <option value="0" label="min">
            <option value="2" label="max">
          </datalist>
        </div>
        <div id="bpm-control">
          <label for="bpm">BPM</label>
          <input name="bpm" id="bpm" type="range" min="60" max="180" value="120" step="1" />
       </div>
      </div>
      <div id="play-button">
        <label for="playBtn" class="container">play
          <input type="checkbox" id="playBtn" />
          <span class="checkmark"></span>
        </label>
      </div>
  </section>

	<section id="row-one">
		<section class="pads">
      <label for="v1n1" class="container"><p>Voice 1, Note 1</p>
        <input type="checkbox" id="v1n1" />
        <span class="checkmark"></span>
      </label>
			<label for="v1n2" class="container"><p>Voice 1, Note 2</p>
        <input type="checkbox" id="v1n2" />
        <span class="checkmark"></span>
      </label>
			<label for="v1n3" class="container"><p>Voice 1, Note 3</p>
        <input type="checkbox" id="v1n3" />
        <span class="checkmark"></span>
      </label>
			<label for="v1n4" class="container"><p>Voice 1, Note 4</p>
        <input type="checkbox" id="v1n4" />
        <span class="checkmark"></span>
      </label>
      <label for="v1n5" class="container"><p>Voice 1, Note 5</p>
        <input type="checkbox" id="v1n5" />
        <span class="checkmark"></span>
      </label>
			<label for="v1n6" class="container"><p>Voice 1, Note 6</p>
        <input type="checkbox" id="v1n6" />
        <span class="checkmark"></span>
      </label>
			<label for="v1n7" class="container"><p>Voice 1, Note 7</p>
        <input type="checkbox" id="v1n7" />
        <span class="checkmark"></span>
      </label>
			<label for="v1n8" class="container"><p>Voice 1, Note 8</p>
        <input type="checkbox" id="v1n8" />
        <span class="checkmark"></span>
      </label>
    </section>
  </section>

  <section id="row-two">
    <section class="pads">
      <label for="v2n1" class="container"><p>Voice 2, Note 1</p>
        <input type="checkbox" id="v2n1" />
        <span class="checkmark"></span>
      </label>
      <label for="v2n2" class="container"><p>Voice 2, Note 2</p>
        <input type="checkbox" id="v2n2" />
        <span class="checkmark"></span>
      </label>
      <label for="v2n3" class="container"><p>Voice 2, Note 3</p>
        <input type="checkbox" id="v2n3" />
        <span class="checkmark"></span>
      </label>
      <label for="v2n4" class="container"><p>Voice 2, Note 4</p>
        <input type="checkbox" id="v2n4" />
        <span class="checkmark"></span>
      </label>
      <label for="v2n5" class="container"><p>Voice 2, Note 5</p>
        <input type="checkbox" id="v2n5" />
        <span class="checkmark"></span>
      </label>
      <label for="v2n6" class="container"><p>Voice 2, Note 6</p>
        <input type="checkbox" id="v2n6" />
        <span class="checkmark"></span>
      </label>
      <label for="v2n7" class="container"><p>Voice 2, Note 7</p>
        <input type="checkbox" id="v2n7" />
        <span class="checkmark"></span>
      </label>
      <label for="v2n8" class="container"><p>Voice 2, Note 8</p>
        <input type="checkbox" id="v2n8" />
        <span class="checkmark"></span>
      </label>
    </section>
  </section>
  <section id="row-three">
    <section class="pads">
      <label for="v3n1" class="container"><p>Voice 3, Note 1</p>
        <input type="checkbox" id="v3n1" />
        <span class="checkmark"></span>
      </label>
      <label for="v3n2" class="container"><p>Voice 3, Note 2</p>
        <input type="checkbox" id="v3n2" />
        <span class="checkmark"></span>
      </label>
      <label for="v3n3" class="container"><p>Voice 3, Note 3</p>
        <input type="checkbox" id="v3n3" />
        <span class="checkmark"></span>
      </label>
      <label for="v3n4" class="container"><p>Voice 3, Note 4</p>
        <input type="checkbox" id="v3n4" />
        <span class="checkmark"></span>
      </label>
      <label for="v3n5" class="container"><p>Voice 3, Note 5</p>
        <input type="checkbox" id="v3n5" />
        <span class="checkmark"></span>
      </label>
      <label for="v3n6" class="container"><p>Voice 3, Note 6</p>
        <input type="checkbox" id="v3n6" />
        <span class="checkmark"></span>
      </label>
      <label for="v3n7" class="container"><p>Voice 3, Note 7</p>
        <input type="checkbox" id="v3n7" />
        <span class="checkmark"></span>
      </label>
      <label for="v3n8" class="container"><p>Voice 3, Note 8</p>
        <input type="checkbox" id="v3n8" />
        <span class="checkmark"></span>
      </label>
    </section>
  </section>
  <section id="row-four">
    <section class="pads">
      <label for="v4n1" class="container"><p>Voice 4, Note 1</p>
        <input type="checkbox" id="v4n1" />
        <span class="checkmark"></span>
      </label>
      <label for="v4n2" class="container"><p>Voice 4, Note 2</p>
        <input type="checkbox" id="v4n2" />
        <span class="checkmark"></span>
      </label>
      <label for="v4n3" class="container"><p>Voice 4, Note 3</p>
        <input type="checkbox" id="v4n3" />
        <span class="checkmark"></span>
      </label>
      <label for="v4n4" class="container"><p>Voice 4, Note 4</p>
        <input type="checkbox" id="v4n4" />
        <span class="checkmark"></span>
      </label>
      <label for="v4n5" class="container"><p>Voice 4, Note 5</p>
        <input type="checkbox" id="v4n5" />
        <span class="checkmark"></span>
      </label>
      <label for="v4n6" class="container"><p>Voice 4, Note 6</p>
        <input type="checkbox" id="v4n6" />
        <span class="checkmark"></span>
      </label>
      <label for="v4n7" class="container"><p>Voice 4, Note 7</p>
        <input type="checkbox" id="v4n7" />
        <span class="checkmark"></span>
      </label>
      <label for="v4n8" class="container"><p>Voice 4, Note 8</p>
        <input type="checkbox" id="v4n8" />
        <span class="checkmark"></span>
      </label>
    </section>
  </section>
  <section id="row-five">
    <section class="pads">
      <label for="v5n1" class="container"><p>Voice 5, Note 1</p>
        <input type="checkbox" id="v5n1" />
        <span class="checkmark"></span>
      </label>
      <label for="v5n2" class="container"><p>Voice 5, Note 2</p>
        <input type="checkbox" id="v5n2" />
        <span class="checkmark"></span>
      </label>
      <label for="v5n3" class="container"><p>Voice 5, Note 3</p>
        <input type="checkbox" id="v5n3" />
        <span class="checkmark"></span>
      </label>
      <label for="v5n4" class="container"><p>Voice 5, Note 4</p>
        <input type="checkbox" id="v5n4" />
        <span class="checkmark"></span>
      </label>
      <label for="v5n5" class="container"><p>Voice 5, Note 5</p>
        <input type="checkbox" id="v5n5" />
        <span class="checkmark"></span>
      </label>
      <label for="v5n6" class="container"><p>Voice 5, Note 6</p>
        <input type="checkbox" id="v5n6" />
        <span class="checkmark"></span>
      </label>
      <label for="v5n7" class="container"><p>Voice 5, Note 7</p>
        <input type="checkbox" id="v5n7" />
        <span class="checkmark"></span>
      </label>
      <label for="v5n8" class="container"><p>Voice 5, Note 8</p>
        <input type="checkbox" id="v5n8" />
        <span class="checkmark"></span>
      </label>
    </section>
  </section>
  <section id="row-six">
    <section class="pads">
      <label for="v6n1" class="container"><p>Voice 6, Note 1</p>
        <input type="checkbox" id="v6n1" />
        <span class="checkmark"></span>
      </label>
      <label for="v6n2" class="container"><p>Voice 6, Note 2</p>
        <input type="checkbox" id="v6n2" />
        <span class="checkmark"></span>
      </label>
      <label for="v6n3" class="container"><p>Voice 6, Note 3</p>
        <input type="checkbox" id="v6n3" />
        <span class="checkmark"></span>
      </label>
      <label for="v6n4" class="container"><p>Voice 6, Note 4</p>
        <input type="checkbox" id="v6n4" />
        <span class="checkmark"></span>
      </label>
      <label for="v6n5" class="container"><p>Voice 6, Note 5</p>
        <input type="checkbox" id="v6n5" />
        <span class="checkmark"></span>
      </label>
      <label for="v6n6" class="container"><p>Voice 6, Note 6</p>
        <input type="checkbox" id="v6n6" />
        <span class="checkmark"></span>
      </label>
      <label for="v6n7" class="container"><p>Voice 6, Note 7</p>
        <input type="checkbox" id="v6n7" />
        <span class="checkmark"></span>
      </label>
      <label for="v6n8" class="container"><p>Voice 6, Note 8</p>
        <input type="checkbox" id="v6n8" />
        <span class="checkmark"></span>
      </label>
    </section>
  </section>
    <script>
    console.clear();

    //setup
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();

    //volume controls
    const gainNode = audioCtx.createGain();
    const volumeControl = document.querySelector('[data-action="volume"]');
    volumeControl.addEventListener('input', function() {
      gainNode.gain.value = this.value;
    }, false);

    // A minor pentatonic scale
    const A3 = 220;
    const C4 = 261.63;
    const D4 = 293.66;
    const E4 = 329.63;
    const G4 = 392;
    const A4 = 440;

    // time
    let tempo = 60.0;
    const bpmControl = document.querySelector("#bpm");
    const bpmValEl = document.querySelector("#bpmval");

    bpmControl.addEventListener("input",(ev) => {
      tempo = parseInt(ev.target.value, 10);
      //bpmValEl.innerText = tempo;
    }, false);

    const lookahead = 25.0; //how often to call scheduling function in ms
    const scheduleAheadTime = 0.1; //how far ahead to schedule in seconds

    let currentNote = 0;
    let nextNoteTime = 0.0;
    let meter = 8; // number of steps in sequencer
    function nextNote() {
      const secondsPerBeat = 60.0 / tempo;
      nextNoteTime += secondsPerBeat;
      currentNote = (currentNote + 1) % meter;
    }
    // oscillators

    const sweepLength = 1;
    const releaseTime = 0.5;
    const attackTime = 0.2;
    const sweepEnv = new GainNode(audioCtx);

    function playOsc1(time) {
      const osc1 = new OscillatorNode(audioCtx, {
        frequency: A3,
        type: "triangle"
      });
      // sweepEnv.gain.cancelScheduledValues(time);
      // sweepEnv.gain.setValueAtTime(0, time);
      // sweepEnv.gain.linearRampToValueAtTime(1, time + attackTime);
      // sweepEnv.gain.linearRampToValueAtTime(
      // 	0,
      //   time + sweepLength - releaseTime
      // );
      // osc1.connect(sweepEnv).connect(audioCtx.destination);
      osc1.connect(audioCtx.destination);
      osc1.start(time);
      osc1.stop(time + sweepLength);
    }
    function playOsc2(time) {
      const osc2 = new OscillatorNode(audioCtx, {
        frequency: C4,
        type: "triangle"
      });
      osc2.connect(audioCtx.destination);
      osc2.start(time);
      osc2.stop(time + sweepLength);
    }
    function playOsc3(time) {
      const osc3 = new OscillatorNode(audioCtx, {
        frequency: D4,
        type: "triangle"
      });
      osc3.connect(audioCtx.destination);
      osc3.start(
        time);
      osc3.stop(time + sweepLength);
    }
    function playOsc4(time) {
      const osc4 = new OscillatorNode(audioCtx, {
        frequency: E4,
        type: "triangle"
      });
      osc4.connect(audioCtx.destination);
      osc4.start(
        time);
      osc4.stop(time + sweepLength);
    }
    function playOsc5(time) {
      const osc5 = new OscillatorNode(audioCtx, {
        frequency: G4,
        type: "triangle"
      });
      osc5.connect(audioCtx.destination);
      osc5.start(
        time);
      osc5.stop(time + sweepLength);
    }
    function playOsc6(time) {
      const osc6 = new OscillatorNode(audioCtx, {
        frequency: A4,
        type: "triangle"
      });
      osc6.connect(audioCtx.destination);
      osc6.start(
        time);
      osc6.stop(time + sweepLength);
    }

    const pads = document.querySelectorAll(".pads");

    // Sequencer
    const notesInQueue = [];

    function scheduleNote(beatNumber, time) {
      notesInQueue.push({ note: beatNumber, time: time });

      if (pads[0].querySelectorAll("input")[beatNumber].checked) {
        playOsc1(time);
      }
      if (pads[1].querySelectorAll("input")[beatNumber].checked) {
        playOsc2(time);
      }
      if (pads[2].querySelectorAll("input")[beatNumber].checked) {
        playOsc3(time);
      }
      if (pads[3].querySelectorAll("input")[beatNumber].checked) {
        playOsc4(time);
      }
      if (pads[4].querySelectorAll("input")[beatNumber].checked) {
        playOsc5(time);
      }
      if (pads[5].querySelectorAll("input")[beatNumber].checked) {
        playOsc6(time);
      }
    }

    let timerID;
    function scheduler() {
      while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
        scheduleNote(currentNote, nextNoteTime);
        nextNote();
      }
      timerID = setTimeout(scheduler, lookahead);
    }

    // animation
    let lastNoteDrawn = meter - 1;
    function draw() {
      let drawNote = lastNoteDrawn;
      const currentTime = audioCtx.currentTime;
      while (notesInQueue.length && notesInQueue[0].time < currentTime) {
        drawNote = notesInQueue[0].note;
        notesInQueue.shift();
      }
      if (lastNoteDrawn !== drawNote) {
        pads.forEach((pad) => {
          pad.querySelectorAll(".checkmark")[lastNoteDrawn].style.borderColor = "var(--normal)";
          pad.querySelectorAll(".checkmark")[drawNote].style.borderColor = "var(--highlight)";
        });
        lastNoteDrawn = drawNote;
      }
      requestAnimationFrame(draw);
    }

    // playback
    const playButton = document.querySelector("#playBtn");
    let isPlaying = false;

    playButton.addEventListener("click", (ev) => {
      isPlaying = !isPlaying;

      if (isPlaying) {
        if (audioCtx.state === "suspended") {
          audioCtx.resume();
        }
        currentNote = 0;
        nextNoteTime = audioCtx.currentTime;
        scheduler();
        requestAnimationFrame(draw);
        ev.target.dataset.playing = "true";
      } else {
        clearTimeout(timerID);
        ev.target.dataset.playing = "false";
      }
    });

    </script>
  </body>
</html>
